<app-header></app-header>

<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1>Your Weekly Meal Plans</h1>
    <p class="subtitle">Plan, cook, and enjoy healthy meals tailored just for you</p>
  </div>

  <!-- Week Selection Tabs -->
  <mat-card class="week-selector">
    <mat-tab-group 
      [selectedIndex]="selectedWeekIndex()" 
      (selectedIndexChange)="loadWeekMealPlan($event)"
      class="week-tabs">
      @for (week of availableWeeks(); track week.weekIdentifier) {
        <mat-tab [label]="week.displayText"></mat-tab>
      }
    </mat-tab-group>
  </mat-card>

  <!-- Loading State -->
  @if (loading()) {
    <mat-card class="loading-card">
      <div class="loading-content">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading your meal plan...</p>
      </div>
    </mat-card>
  }

  <!-- Error State -->
  @if (error()) {
    <mat-card class="error-card">
      <div class="error-content">
        <mat-icon color="warn">error</mat-icon>
        <p>{{ error() }}</p>
        <button mat-button color="primary" (click)="loadWeekMealPlan(selectedWeekIndex())">
          Try Again
        </button>
      </div>
    </mat-card>
  }

  <!-- No Meal Plan State -->
  @if (!loading() && !error() && !currentMealPlan()) {
    <mat-card class="no-plan-card">
      <div class="no-plan-content">
        <mat-icon class="large-icon">restaurant_menu</mat-icon>
        <h2>No Meal Plan for This Week</h2>
        <p>Generate a personalized meal plan based on your preferences and dietary needs.</p>
        <button mat-raised-button color="primary" (click)="generateMealPlan()" [disabled]="loading()">
          <mat-icon>add</mat-icon>
          Generate Meal Plan
        </button>
      </div>
    </mat-card>
  }

  <!-- Meal Plan Content -->
  @if (!loading() && !error() && currentMealPlan(); as mealPlan) {
    <div class="meal-plan-content">
      
      <!-- Meal Plan Overview -->
      <mat-card class="overview-card">
        <mat-card-header>
          <mat-card-title>Week Overview</mat-card-title>
          <mat-card-subtitle>
            {{ availableWeeks()[selectedWeekIndex()].displayText }}
          </mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="overview-stats">
            <div class="stat">
              <mat-icon>attach_money</mat-icon>
              <span class="value">{{ formatCurrency(mealPlan.totalEstimatedCost) }}</span>
              <span class="label">Total Cost</span>
            </div>
            <div class="stat">
              <mat-icon>local_fire_department</mat-icon>
              <span class="value">{{ mealPlan.weeklyNutritionSummary.averageCaloriesPerDay | number:'1.0-0' }}</span>
              <span class="label">Avg Calories/Day</span>
            </div>
            <div class="stat">
              <mat-icon>fitness_center</mat-icon>
              <span class="value">{{ mealPlan.weeklyNutritionSummary.totalProtein | number:'1.0-0' }}g</span>
              <span class="label">Total Protein</span>
            </div>
            <div class="stat">
              <mat-chip [color]="getStatusColor(mealPlan.status)">
                {{ mealPlan.status }}
              </mat-chip>
            </div>
          </div>
          
          <div class="overview-actions">
            <button mat-button color="primary" (click)="generateMealPlan()">
              <mat-icon>refresh</mat-icon>
              Regenerate Plan
            </button>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Daily Meals Grid -->
      <div class="daily-meals-grid">
        @for (dayData of weekMealData(); track dayData.dayName) {
          <mat-card class="day-card">
            <mat-card-header>
              <mat-card-title>{{ dayData.dayName }}</mat-card-title>
              <mat-card-subtitle>
                {{ dayData.date | date:'MMM d' }}
              </mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <!-- Meals for the day -->
              <div class="meals-list">
                
                <!-- Breakfast -->
                @if (dayData.breakfast) {
                  <div class="meal-item">
                    <div class="meal-header">
                      <mat-icon>{{ getMealTypeIcon('breakfast') }}</mat-icon>
                      <span class="meal-type">Breakfast</span>
                      <span class="meal-time">{{ formatTime(dayData.breakfast.estimatedPrepTime + dayData.breakfast.estimatedCookTime) }}</span>
                    </div>
                    <div class="meal-details">
                      <h4>{{ dayData.breakfast.name }}</h4>
                      <p class="meal-nutrition">
                        {{ dayData.breakfast.nutrition.calories }} cal • 
                        {{ dayData.breakfast.nutrition.protein }}g protein
                      </p>
                      @if (dayData.breakfast.recipe.cuisine) {
                        <mat-chip class="cuisine-chip">{{ dayData.breakfast.recipe.cuisine }}</mat-chip>
                      }
                    </div>
                  </div>
                  <mat-divider></mat-divider>
                }

                <!-- Lunch -->
                @if (dayData.lunch) {
                  <div class="meal-item">
                    <div class="meal-header">
                      <mat-icon>{{ getMealTypeIcon('lunch') }}</mat-icon>
                      <span class="meal-type">Lunch</span>
                      <span class="meal-time">{{ formatTime(dayData.lunch.estimatedPrepTime + dayData.lunch.estimatedCookTime) }}</span>
                    </div>
                    <div class="meal-details">
                      <h4>{{ dayData.lunch.name }}</h4>
                      <p class="meal-nutrition">
                        {{ dayData.lunch.nutrition.calories }} cal • 
                        {{ dayData.lunch.nutrition.protein }}g protein
                      </p>
                      @if (dayData.lunch.recipe.cuisine) {
                        <mat-chip class="cuisine-chip">{{ dayData.lunch.recipe.cuisine }}</mat-chip>
                      }
                    </div>
                  </div>
                  <mat-divider></mat-divider>
                }

                <!-- Dinner -->
                @if (dayData.dinner) {
                  <div class="meal-item">
                    <div class="meal-header">
                      <mat-icon>{{ getMealTypeIcon('dinner') }}</mat-icon>
                      <span class="meal-type">Dinner</span>
                      <span class="meal-time">{{ formatTime(dayData.dinner.estimatedPrepTime + dayData.dinner.estimatedCookTime) }}</span>
                    </div>
                    <div class="meal-details">
                      <h4>{{ dayData.dinner.name }}</h4>
                      <p class="meal-nutrition">
                        {{ dayData.dinner.nutrition.calories }} cal • 
                        {{ dayData.dinner.nutrition.protein }}g protein
                      </p>
                      @if (dayData.dinner.recipe.cuisine) {
                        <mat-chip class="cuisine-chip">{{ dayData.dinner.recipe.cuisine }}</mat-chip>
                      }
                    </div>
                  </div>
                  <mat-divider></mat-divider>
                }

                <!-- Snacks -->
                @if (dayData.snacks && dayData.snacks.length > 0) {
                  <div class="meal-item">
                    <div class="meal-header">
                      <mat-icon>{{ getMealTypeIcon('snack') }}</mat-icon>
                      <span class="meal-type">Snacks</span>
                    </div>
                    <div class="snacks-list">
                      @for (snack of dayData.snacks; track snack.id) {
                        <div class="snack-item">
                          <span class="snack-name">{{ snack.name }}</span>
                          <span class="snack-nutrition">{{ snack.nutrition.calories }} cal</span>
                        </div>
                      }
                    </div>
                  </div>
                }

                <!-- No meals planned -->
                @if (!dayData.breakfast && !dayData.lunch && !dayData.dinner && (!dayData.snacks || dayData.snacks.length === 0)) {
                  <div class="no-meals">
                    <mat-icon>restaurant</mat-icon>
                    <p>No meals planned</p>
                  </div>
                }
              </div>
              
              <!-- Daily Summary -->
              <div class="daily-summary">
                <div class="summary-item">
                  <span class="summary-label">Total Calories:</span>
                  <span class="summary-value">{{ dayData.dailyNutrition.totalCalories | number:'1.0-0' }}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Cost:</span>
                  <span class="summary-value">{{ formatCurrency(dayData.dailyEstimatedCost) }}</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        }
      </div>

      <!-- Grocery List Section -->
      @if (mealPlan.groceryList && mealPlan.groceryList.items && mealPlan.groceryList.items.length > 0) {
        <mat-card class="grocery-list-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>shopping_cart</mat-icon>
              Shopping List
            </mat-card-title>
            <mat-card-subtitle>
              {{ mealPlan.groceryList.items.length }} items • 
              {{ formatCurrency(mealPlan.groceryList.totalEstimatedCost) }}
            </mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="grocery-categories">
              <!-- Group items by category for better organization -->
              <!-- This would need additional logic to group by category -->
              <div class="grocery-items">
                @for (item of mealPlan.groceryList.items; track item.id) {
                  <div class="grocery-item">
                    <span class="item-name">{{ item.name }}</span>
                    <span class="item-quantity">{{ item.quantity }} {{ item.unit }}</span>
                    <span class="item-cost">{{ formatCurrency(item.estimatedCost) }}</span>
                  </div>
                }
              </div>
            </div>
          </mat-card-content>
          <mat-card-actions>
            <button mat-button color="primary">
              <mat-icon>print</mat-icon>
              Print List
            </button>
            <button mat-button color="primary">
              <mat-icon>share</mat-icon>
              Share List
            </button>
          </mat-card-actions>
        </mat-card>
      }
    </div>
  }
</div>
